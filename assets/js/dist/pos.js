!function(t){"use strict";class s{constructor(){this.cart=[],this.customer=null,this.settings={},this.init()}init(){this.bindEvents(),this.loadSettings(),this.initializeComponents(),"undefined"!=typeof feather&&feather.replace()}bindEvents(){t(document).on("click",".product-item",this.addToCart.bind(this)),t(document).on("click",".remove-item",this.removeFromCart.bind(this)),t(document).on("change",".quantity-input",this.updateQuantity.bind(this)),t("#customer-search").on("input",this.searchCustomers.bind(this)),t(document).on("click",".customer-item",this.selectCustomer.bind(this)),t("#checkout-btn").on("click",this.startCheckout.bind(this)),t("#process-payment").on("click",this.processPayment.bind(this)),t("#product-search").on("input",this.searchProducts.bind(this)),t(".category-filter").on("click",this.filterByCategory.bind(this))}loadSettings(){t.ajax({url:wupos_pos.rest_url+"settings",type:"GET",headers:{"X-WP-Nonce":wupos_pos.rest_nonce},success:t=>{this.settings=t,this.updateUISettings()},error:(t,s,e)=>{console.error("Failed to load settings:",e)}})}initializeComponents(){this.loadProducts(),this.updateCartDisplay(),this.updateTotals()}loadProducts(s=1,e="",r=0){const a={page:s,per_page:20,search:e,category:r};t.ajax({url:wupos_pos.rest_url+"products",type:"GET",data:a,headers:{"X-WP-Nonce":wupos_pos.rest_nonce},success:t=>{this.displayProducts(t.products),this.updatePagination(t)},error:(t,s,e)=>{console.error("Failed to load products:",e),this.showError(wupos_pos.strings.error)}})}displayProducts(s){const e=t(".products-grid");e.empty(),0!==s.length?s.forEach(t=>{const s=this.createProductHTML(t);e.append(s)}):e.html('<div class="col-12"><p class="text-center">'+wupos_pos.strings.no_products+"</p></div>")}createProductHTML(t){const s=this.formatPrice(t.price),e=t.image_url||wupos_pos.default_image;return`\n                <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">\n                    <div class="product-item card h-100" data-product-id="${t.id}" data-product='${JSON.stringify(t)}'>\n                        <div class="product-image">\n                            <img src="${e}" alt="${t.name}" class="card-img-top">\n                        </div>\n                        <div class="card-body p-2">\n                            <h6 class="card-title mb-1">${t.name}</h6>\n                            <p class="card-text mb-1">\n                                <small class="text-muted">${t.sku||""}</small>\n                            </p>\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span class="price font-weight-bold">${s}</span>\n                                <span class="stock badge badge-${"instock"===t.stock_status?"success":"warning"}">\n                                    ${t.stock_quantity||"âˆž"}\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `}addToCart(s){const e=t(s.currentTarget).data("product");if(!e)return;const r=this.cart.findIndex(t=>t.id===e.id);r>=0?this.cart[r].quantity+=1:this.cart.push({...e,quantity:1,line_total:parseFloat(e.price)}),this.updateCartDisplay(),this.updateTotals(),this.playSound("add")}removeFromCart(s){const e=t(s.currentTarget).data("index");confirm(wupos_pos.strings.confirm_remove)&&(this.cart.splice(e,1),this.updateCartDisplay(),this.updateTotals(),this.playSound("remove"))}updateQuantity(s){const e=t(s.currentTarget).data("index"),r=parseInt(t(s.currentTarget).val());r>0?(this.cart[e].quantity=r,this.cart[e].line_total=this.cart[e].price*r):this.cart.splice(e,1),this.updateCartDisplay(),this.updateTotals()}updateCartDisplay(){const s=t(".cart-items");s.empty(),0!==this.cart.length?(this.cart.forEach((t,e)=>{const r=`\n                    <div class="cart-item d-flex align-items-center mb-2 p-2 border-bottom">\n                        <div class="flex-grow-1">\n                            <h6 class="mb-1">${t.name}</h6>\n                            <small class="text-muted">${t.sku||""}</small>\n                        </div>\n                        <div class="quantity mx-2">\n                            <input type="number" class="form-control form-control-sm quantity-input" \n                                   value="${t.quantity}" min="1" data-index="${e}" style="width: 60px;">\n                        </div>\n                        <div class="price mx-2">\n                            ${this.formatPrice(t.line_total)}\n                        </div>\n                        <button class="btn btn-sm btn-outline-danger remove-item" data-index="${e}">\n                            <i data-feather="x"></i>\n                        </button>\n                    </div>\n                `;s.append(r)}),"undefined"!=typeof feather&&feather.replace()):s.html('<div class="text-center p-3">'+wupos_pos.strings.empty_cart+"</div>")}updateTotals(){const s=this.cart.reduce((t,s)=>t+s.line_total,0),e=this.calculateTax(s),r=s+e;t(".subtotal-amount").text(this.formatPrice(s)),t(".tax-amount").text(this.formatPrice(e)),t(".total-amount").text(this.formatPrice(r)),t("#checkout-btn").prop("disabled",0===this.cart.length)}calculateTax(t){return.1*t}formatPrice(t){const s=this.settings.currency_symbol||wupos_pos.currency_symbol,e=this.settings.currency_position||wupos_pos.currency_position,r=parseFloat(t).toFixed(2);switch(e){case"left":default:return s+r;case"right":return r+s;case"left_space":return s+" "+r;case"right_space":return r+" "+s}}searchProducts(s){const e=t(s.target).val();clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.loadProducts(1,e)},300)}searchCustomers(s){const e=t(s.target).val();e.length<2?t(".customer-results").hide():t.ajax({url:wupos_pos.rest_url+"customers",type:"GET",data:{search:e},headers:{"X-WP-Nonce":wupos_pos.rest_nonce},success:t=>{this.displayCustomerResults(t)},error:(t,s,e)=>{console.error("Failed to search customers:",e)}})}displayCustomerResults(s){const e=t(".customer-results");e.empty(),s.forEach(t=>{const s=`\n                    <div class="customer-item p-2 border-bottom" data-customer='${JSON.stringify(t)}'>\n                        <div class="font-weight-bold">${t.display_name}</div>\n                        <small class="text-muted">${t.email}</small>\n                    </div>\n                `;e.append(s)}),e.show()}selectCustomer(s){const e=t(s.currentTarget).data("customer");this.customer=e,t("#customer-search").val(e.display_name),t(".customer-results").hide(),t(".selected-customer").show().find(".customer-name").text(e.display_name)}startCheckout(){0!==this.cart.length?(t("#checkout-modal").modal("show"),this.updateCheckoutSummary()):this.showError(wupos_pos.strings.empty_cart)}updateCheckoutSummary(){const s=this.cart.reduce((t,s)=>t+s.line_total,0),e=this.calculateTax(s),r=s+e;t("#checkout-subtotal").text(this.formatPrice(s)),t("#checkout-tax").text(this.formatPrice(e)),t("#checkout-total").text(this.formatPrice(r))}processPayment(){const s=t('input[name="payment_method"]:checked').val();s?this.createOrder().then(t=>{if(t)return this.processOrderPayment(t,s)}).then(t=>{t&&t.success?this.onPaymentSuccess(t.data):this.showError(wupos_pos.strings.payment_failed)}).catch(t=>{console.error("Payment processing error:",t),this.showError(wupos_pos.strings.payment_failed)}):this.showError("Please select a payment method")}createOrder(){const s={customer_id:this.customer?this.customer.id:0,line_items:this.cart.map(t=>({product_id:t.id,quantity:t.quantity})),terminal_id:wupos_pos.session_id};return new Promise((e,r)=>{t.ajax({url:wupos_pos.rest_url+"orders",type:"POST",data:JSON.stringify(s),contentType:"application/json",headers:{"X-WP-Nonce":wupos_pos.rest_nonce},success:t=>{e(t.id)},error:(t,s,e)=>{console.error("Order creation failed:",e),r(e)}})})}processOrderPayment(s,e){const r={method:e};if("cash"===e){const s=parseFloat(t("#cash-received").val())||0,e=this.cart.reduce((t,s)=>t+s.line_total,0),a=e+this.calculateTax(e);r.cash_received=s,r.change_given=Math.max(0,s-a)}return new Promise((e,a)=>{t.ajax({url:wupos_pos.rest_url+"orders/"+s+"/payment",type:"POST",data:JSON.stringify(r),contentType:"application/json",headers:{"X-WP-Nonce":wupos_pos.rest_nonce},success:t=>{e({success:!0,data:t})},error:(t,s,e)=>{console.error("Payment processing failed:",e),a(e)}})})}onPaymentSuccess(s){t("#checkout-modal").modal("hide"),this.showSuccess(wupos_pos.strings.payment_success),this.cart=[],this.customer=null,this.updateCartDisplay(),this.updateTotals(),t("#customer-search").val(""),t(".selected-customer").hide(),this.playSound("success"),"yes"===this.settings.auto_print_receipt&&this.printReceipt(s)}playSound(t){"yes"!==this.settings.sound_enabled&&"yes"!==wupos_pos.sound_enabled||new Audio}printReceipt(t){console.log("Printing receipt for order:",t)}showError(t){alert(t)}showSuccess(t){alert(t)}updateUISettings(){console.log("Settings loaded:",this.settings)}filterByCategory(s){const e=t(s.currentTarget).data("category");this.loadProducts(1,"",e)}updatePagination(t){console.log("Pagination:",t)}}t(document).ready(function(){window.WUPOS=new s})}(jQuery);